{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "scaleUnit": {
            "type": "string",
            "metadata": {
                "description": "Describes the scale unit that is to be used to uniquely identify each resource"
            }
        },
        "cors": {
            "type": "array",
            "metadata": {
                "description": "Allowed Origins"
            }
        },
        "WEBSITE_LOAD_CERTIFICATES": {
            "type": "string",
            "metadata": {
                "description": "WEBSITE_LOAD_CERTIFICATES"
            }
        },
        "MLServiceSetting": {
            "type": "string",
            "metadata": {
                "description": "FCB Setting for ML Service"
            }
        },
        "EmailInsightsEnabled": {
            "type": "string",
            "metadata": {
                "description": "FCB Setting for Email Insights"
            }
        },
        "SkipEntityConfigCache": {
            "type": "string",
            "metadata": {
                "description": "FCB Setting for Entity config cache"
            }
        },
        "S2SEventSourceShowPII": {
            "type": "string",
            "metadata": {
                "description": "FCB Setting for showing PII in S2S failures telemetry"
            }
        },
        "packageLink": {
            "type": "string",
            "metadata": {
                "description": "Ev2 Deploy Url for Package"
            }
        },
        "Ev2TemplateSAS": {
            "type": "securestring",
            "metadata": {
                "description": "SAS key for the Build Artifacts"
            }
        },
        "CNameDomainName": {
            "type": "string",
            "metadata": {
                "description": "The Cname Domain Suffix used"
            }
        },
        "BaseExternalDependencies": {
            "type": "object",
            "metadata": {
                "description": "Base External Depedencies For Sales Copilot"
            }
        },
        "MSTeamsVivaSalesAppId": {
            "type": "string",
            "metadata": {
                "description": "Viva Sales Teams app id"
            }
        },
        "MSTeamsServiceAppId": {
            "type": "string",
            "metadata": {
                "description": "Service Copilot Teams app id"
            }
        },
        "CIServiceBasePath": {
            "type": "string",
            "metadata": {
                "description": "CIServiceBasePath"
            }
        },
        "MRServiceBasePath": {
            "type": "string",
            "metadata": {
                "description": "MRServiceBasePath"
            }
        },
        "MeoBaseEndpoint": {
            "type": "string",
            "metadata": {
                "description": "MeoBaseEndpoint"
            }
        },
        "NotificationFrameworkConfiguration": {
            "type": "object",
            "metadata": {
                "description": "Notification framework Config values"
            }
        },
        "TeamsNotificationsJobsConfiguration": {
            "type": "object",
            "metadata": {
                "description": "Teams notifications jbos config values"
            }
        },
        "MRAppId": {
            "type": "string",
            "metadata": {
                "description": "MRAppId"
            }
        },
        "IsProdFirstPartyApp": {
            "type": "bool",
            "metadata": {
                "description": "IsProdFirstPartyApp"
            }
        },
        "WEBSITE_FIRST_PARTY_ID": {
            "type": "string"
        },
        "vivaSalesClientAppId": {
            "type": "string"
        },
        "vivaSalesLicensing1pAppId": {
            "type": "string"
        },
        "vivaSalesValidAudiences0": {
            "type": "string"
        },
        "CommonTenant": {
            "type": "string"
        },
        "Sendx5cBool": {
            "type": "string"
        },
        "vivaSalesLicensingCertName": {
            "type": "string"
        },
        "KeyvaultLiteral": {
            "type": "string"
        },
        "IsFirstPartyApp": {
            "type": "bool"
        },
        "enableDevOrigins": {
            "type": "bool"
        },
        "AzureRegion": {
            "type": "string"
        },
        "vnet": {
            "defaultValue": "vnet-salesproductivity",
            "type": "string"
        },
        "msAppId": {
            "type": "string"
        },
        "tokenCacheExpiryMinutes": {
            "type": "int"
        },
        "isBAPApiRoutingRequired": {
            "type": "bool"
        },
        "enableSFS2SAuth": {
            "type": "bool"
        },
        "DiscoveryServiceTargets": {
            "type": "string"
        },
        "DefaultEnvironmentLocation": {
            "type": "string"
        },
        "MicrosoftAppPassword": {
            "type": "securestring"
        },
        "env_type": {
            "type": "string"
        },
        "vivaSalesApplicationId": {
            "type": "string"
        },
        "webappPrefix": {
            "type": "string",
            "metadata": {
                "description": "Prefix for the Web App being deployed"
            }
        },
        "customdomaincdnendpoint": {
            "type": "string",
            "metadata": {
                "description": "Custom Domain CDN Endpoint"
            }
        },
        "defaultLocationExpiryDays": {
            "type": "int",
            "defaultValue": 7,
            "metadata": {
                "description": "Service's Cache Manager default expiry time in days for storing location."
            }
        },
        "crmConnectionDetailsCacheExpiryMinutes": {
            "type": "int",
            "defaultValue": 15,
            "metadata": {
                "description": "Service's Cache Manager expiry time in minutes for storing CRM connection details."
            }
        },
        "islandHostname": {
            "type": "string",
            "defaultValue": "https://insightsplatform.wus-il201.gateway.test.island.powerapps.com",
            "metadata": {
                "description": "island hostname for querying AI Builder API"
            }
        },
        "buildVersion": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Build version for the site, needed for slot auto-swap."
            }
        },
        "hstsMaxAgeInMinutes": {
            "type": "int",
            "defaultValue": 525600,
            "metadata": {
                "description": "HSTS max age in minutes"
            }
        }
    },
    "variables": {
        "spWebAppHostingPlanPrefix": "spservicehostingplan",
        "vaults_salesproductivity_name": "[concat('spkeyvault', parameters('scaleUnit'))]",
        "location": "[resourceGroup().location]",
        "spWebAppHostingPlanName": "[concat(variables('spWebAppHostingPlanPrefix'),parameters('scaleUnit'))]",
        "spWebAppName": "[concat(parameters('webappPrefix'),parameters('scaleUnit'))]",
        "bgJobPrefix": "vivabgjobs",
        "backgroundJobsStorageAccName": "[concat(variables('bgJobPrefix'),parameters('scaleUnit'))]",
        "CdnCors": "[replace(replace(replace(string(concat(parameters('cors'), array(parameters('cors')))),'[',''), ']', ''), '\"', '')]",
        "cosmosdb": "cosmosdatabase",
        "cosmosdatabasename": "[concat(variables('cosmosdb'),parameters('scaleUnit'))]",
        "servicePackageLink": "[concat(parameters('packageLink'), parameters('Ev2TemplateSAS'))]",
        "vnetName": "[concat(parameters('vnet'),parameters('scaleUnit'))]",
        "redisCacheConfStringSecretName": "redisServerConfString",
        "kvUrl": "[concat('https://', variables('vaults_salesproductivity_name'), '.vault.azure.net/')]",
        "renameMSDeployLockedFiles": 1,
        "donotPreserveFiletime": 1,
        "DerivedCustomdomaincdnendpoint": "[concat(parameters('scaleUnit'),'.' ,parameters('CNameDomainName'), '.dynamics.com')]",
        "customdomaincdnendpoint": "[if(equals(parameters('customdomaincdnendpoint'), ''), variables('DerivedCustomdomaincdnendpoint'), parameters('customdomaincdnendpoint'))]",
        "customdomainappservicePrefix": "[if(equals(parameters('env_type'), 'Prod'), '.', 'service.')]",
        "customdomainappservice": "[concat(parameters('scaleUnit'),variables('customdomainappservicePrefix') ,parameters('CNameDomainName'), '.dynamics.com')]",
        "decryptionCert": "[concat('salesproductivity-encryption-' ,parameters('scaleUnit'))]",
        "CIVivaTabUrl": "[concat('https://',variables('customdomaincdnendpoint'), '/teamsapp/meeting-tab.html')]",
        "UserLicenseCacheExpirationInMinutes": 5
    },
    "resources": [
        {
            "type": "Microsoft.Web/sites/slots",
            "apiVersion": "2018-02-01",
            "name": "[concat(variables('spWebAppName'), '/staging')]",
            "location": "[variables('location')]",
            "kind": "app",
            "properties": {
                "buildVersion": "[parameters('buildVersion')]",
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('spWebAppHostingPlanName'))]",
                "httpsOnly": true,
                "netFrameworkVersion": "v8.0",
                "siteConfig": {
                    "location": "[variables('location')]",
                    "AlwaysOn": true,
                    "appSettings": [
                        {
                            "name": "MLServiceSetting",
                            "value": "[parameters('MLServiceSetting')]"
                        },
                        {
                            "name": "EmailInsightsEnabled",
                            "value": "[parameters('EmailInsightsEnabled')]"
                        },
                        {
                            "name": "SkipEntityConfigCache",
                            "value": "[parameters('SkipEntityConfigCache')]"
                        },
                        {
                            "name": "S2SEventSourceShowPII",
                            "value": "[parameters('S2SEventSourceShowPII')]"
                        },
                        {
                            "name": "BAPClientId",
                            "value": "[parameters('BaseExternalDependencies').BAPClientId]"
                        },
                        {
                            "name": "BAPEndPoint",
                            "value": "[parameters('BaseExternalDependencies').BAPEndPoint]"
                        },
                        {
                            "name": "MSTeamsVivaSalesAppId",
                            "value": "[parameters('MSTeamsVivaSalesAppId')]"
                        },
                        {
                            "name": "MSTeamsServiceAppId",
                            "value": "[parameters('MSTeamsServiceAppId')]"
                        },
                        {
                            "name": "CIVivaTabUrl",
                            "value": "[variables('CIVivaTabUrl')]"
                        },
                        {
                            "name": "CIServiceBasePath",
                            "value": "[parameters('CIServiceBasePath')]"
                        },
                        {
                            "name": "MRServiceBasePath",
                            "value": "[parameters('MRServiceBasePath')]"
                        },
                        {
                            "name": "MeoBaseEndpoint",
                            "value": "[parameters('MeoBaseEndpoint')]"
                        },
                        {
                            "name": "MeoProcessorJobRepeatIntervalInMinutes",
                            "value": "[parameters('NotificationFrameworkConfiguration').MeoProcessorJobRepeatIntervalInMinutes]"
                        },
                        {
                            "name": "MeoProcessorJobNotificationDbBatchSize",
                            "value": "[parameters('NotificationFrameworkConfiguration').MeoProcessorJobNotificationDbBatchSize]"
                        },
                        {
                            "name": "MeoProcessorJobBusinessStartTime",
                            "value": "[parameters('NotificationFrameworkConfiguration').MeoProcessorJobBusinessStartTime]"
                        },
                        {
                            "name": "MeoProcessorJobBusinessEndTime",
                            "value": "[parameters('NotificationFrameworkConfiguration').MeoProcessorJobBusinessEndTime]"
                        },
                        {
                            "name": "MeoStatusUpdateJobRetryIntervalInMinutes",
                            "value": "[parameters('NotificationFrameworkConfiguration').MeoStatusUpdateJobRetryIntervalInMinutes]"
                        },
                        {
                            "name": "MeoStatusUpdateJobMaxRetryCount",
                            "value": "[parameters('NotificationFrameworkConfiguration').MeoStatusUpdateJobMaxRetryCount]"
                        },
                        {
                            "name": "TeamsProcessorJobRepeatIntervalInMinutes",
                            "value": "[parameters('TeamsNotificationsJobsConfiguration').TeamsProcessorJobRepeatIntervalInMinutes]"
                        },
                        {
                            "name": "TeamsProcessorJobNotificationDbBatchSize",
                            "value": "[parameters('TeamsNotificationsJobsConfiguration').TeamsProcessorJobNotificationDbBatchSize]"
                        },
                        {
                            "name": "TeamsProcessorJobBusinessStartTime",
                            "value": "[parameters('TeamsNotificationsJobsConfiguration').TeamsProcessorJobBusinessStartTime]"
                        },
                        {
                            "name": "TeamsProcessorJobBusinessEndTime",
                            "value": "[parameters('TeamsNotificationsJobsConfiguration').TeamsProcessorJobBusinessEndTime]"
                        },
                        {
                            "name": "TeamsSenderJobRetryIntervalInMinutes",
                            "value": "[parameters('TeamsNotificationsJobsConfiguration').TeamsSenderJobRetryIntervalInMinutes]"
                        },
                        {
                            "name": "TeamsSenderJobMaxRetryCount",
                            "value": "[parameters('TeamsNotificationsJobsConfiguration').TeamsSenderJobMaxRetryCount]"
                        },
                        {
                            "name": "TeamsThrottlerPolicyTimeSpanInSeconds",
                            "value": "[parameters('TeamsNotificationsJobsConfiguration').TeamsThrottlerPolicyTimeSpanInSeconds]"
                        },
                        {
                            "name": "TeamsThrottlerPolicyItemsPerTimeSpan",
                            "value": "[parameters('TeamsNotificationsJobsConfiguration').TeamsThrottlerPolicyItemsPerTimeSpan]"
                        },
                        {
                            "name": "TeamsThrottlerPolicyRetryCount",
                            "value": "[parameters('TeamsNotificationsJobsConfiguration').TeamsThrottlerPolicyRetryCount]"
                        },
                        {
                            "name": "TeamsThrottlerPolicyRetryIntervalInSeconds",
                            "value": "[parameters('TeamsNotificationsJobsConfiguration').TeamsThrottlerPolicyRetryIntervalInSeconds]"
                        },
                        {
                            "name": "CIAppId",
                            "value": "[parameters('BaseExternalDependencies').CIAppId]"
                        },
                        {
                            "name": "MRAppId",
                            "value": "[parameters('MRAppId')]"
                        },
                        {
                            "name": "IsProdFirstPartyApp",
                            "value": "[parameters('IsProdFirstPartyApp')]"
                        },
                        {
                            "name": "TeamsS2SAllowlistedAppId",
                            "value": "[parameters('BaseExternalDependencies').TeamsS2SAllowlistedAppId]"
                        },
                        {
                            "name": "S2SAllowedApplicationIds",
                            "value": "[parameters('BaseExternalDependencies').S2SAllowedApplicationIds]"
                        },
                        {
                            "name": "WEBSITE_LOAD_CERTIFICATES",
                            "value": "[parameters('WEBSITE_LOAD_CERTIFICATES')]"
                        },
                        {
                            "name": "WEBSITE_FIRST_PARTY_ID",
                            "value": "[parameters('WEBSITE_FIRST_PARTY_ID')]"
                        },
                        {
                            "name": "KVUrl",
                            "value": "[variables('kvUrl')]"
                        },
                        {
                            "name": "AzureAd__ClientId",
                            "value": "[parameters('vivaSalesClientAppId')]"
                        },
                        {
                            "name": "AzureAd__AzureRegion",
                            "value": "[parameters('AzureRegion')]"
                        },
                        {
                            "name": "RedisCache__ConnectionString",
                            "value": "[concat('@Microsoft.KeyVault(VaultName=', variables('vaults_salesproductivity_name'), ';SecretName=', variables('redisCacheConfStringSecretName'), ')')]"
                        },
                        {
                            "name": "AzureAd__TenantId",
                            "value": "[parameters('CommonTenant')]"
                        },
                        {
                            "name": "AzureAd__SendX5C",
                            "value": "[parameters('Sendx5cBool')]"
                        },
                        {
                            "name": "AzureAd__ClientCertificates__0__KeyVaultUrl",
                            "value": "[variables('kvUrl')]"
                        },
                        {
                            "name": "AzureAd__ClientCertificates__0__SourceType",
                            "value": "[parameters('KeyvaultLiteral')]"
                        },
                        {
                            "name": "AzureAd__ClientCertificates__0__KeyVaultCertificateName",
                            "value": "salescopilot-fpa-access"
                        },
                        {
                            "name": "AzureAd__InboundPolicies__1__TokenValidationPolicy__ValidAudiences__0",
                            "value": "[parameters('vivaSalesValidAudiences0')]"
                        },
                        {
                            "name": "AzureAd__InboundPolicies__1__ValidAudiences__0",
                            "value": "[parameters('vivaSalesValidAudiences0')]"
                        },
                        {
                            "name": "AzureAd__InboundPolicies__1__TokenValidationPolicy__TokenDecryptionCertificates__0__KeyVaultUrl",
                            "value": "[variables('kvUrl')]"
                        },
                        {
                            "name": "AzureAd__InboundPolicies__1__TokenValidationPolicy__TokenDecryptionCertificates__0__SourceType",
                            "value": "[parameters('KeyvaultLiteral')]"
                        },
                        {
                            "name": "AzureAd__InboundPolicies__1__TokenValidationPolicy__TokenDecryptionCertificates__0__KeyVaultCertificateName",
                            "value": "[variables('decryptionCert')]"
                        },
                        {
                            "name": "EncryptionCertificateName",
                            "value": "[variables('decryptionCert')]"
                        },
                        {
                            "name": "FirstPartyAppId",
                            "value": "[parameters('vivaSalesClientAppId')]"
                        },
                        {
                            "name": "IsFirstPartyApp",
                            "value": "[parameters('IsFirstPartyApp')]"
                        },
                        {
                            "name": "enableDevOrigins",
                            "value": "[parameters('enableDevOrigins')]"
                        },
                        {
                            "name": "PowerAppsBaseUrl",
                            "value": "[parameters('BaseExternalDependencies').PowerAppsBaseUrl]"
                        },
                        {
                            "name": "AzureRegion",
                            "value": "[parameters('AzureRegion')]"
                        },
                        {
                            "name": "WEBSITE_VNET_ROUTE_ALL",
                            "value": 1
                        },
                        {
                            "name": "allowedOrigins",
                            "value": "[variables('CdnCors')]"
                        },
                        {
                            "name": "cosmosdbAccountEndpoint",
                            "value": "[concat('https://', variables('cosmosdatabasename'), '.documents.azure.com:443/')]"
                        },
                        {
                            "name": "serviceName",
                            "value": "[variables('customdomainappservice')]"
                        },
                        {
                            "name": "cdnEndpoint",
                            "value": "[variables('customdomaincdnendpoint')]"
                        },
                        {
                            "name": "MSDEPLOY_RENAME_LOCKED_FILES",
                            "value": "[variables('renameMSDeployLockedFiles')]"
                        },
                        {
                            "name": "SCM_ZIPDEPLOY_DONOT_PRESERVE_FILETIME",
                            "value": "[variables('donotPreserveFiletime')]"
                        },
                        {
                            "name": "BackgroundJobs__StorageAccountName",
                            "value": "[variables('backgroundJobsStorageAccName')]"
                        },
                        {
                            "name": "BackgroundJobs__UseMemoryStorage",
                            "value": "false"
                        },
                        {
                            "name": "DataProtectionBlobStorageAccountName",
                            "value": "[variables('backgroundJobsStorageAccName')]"
                        },
                        {
                            "name": "MicrosoftAppId",
                            "value": "[parameters('msAppId')]"
                        },
                        {
                            "name": "CIAppResources",
                            "value": "[parameters('BaseExternalDependencies').CIAppResources]"
                        },
                        {
                            "name": "tokenCacheExpiryMinutes",
                            "value": "[parameters('tokenCacheExpiryMinutes')]"
                        },
                        {
                            "name": "isBAPApiRoutingRequired",
                            "value": "[parameters('isBAPApiRoutingRequired')]"
                        },
                        {
                            "name": "enableSFS2SAuth",
                            "value": "[parameters('enableSFS2SAuth')]"
                        },
                        {
                            "name": "DiscoveryServiceTargets",
                            "value": "[parameters('DiscoveryServiceTargets')]"
                        },
                        {
                            "name": "DefaultEnvironmentLocation",
                            "value": "[parameters('DefaultEnvironmentLocation')]"
                        },
                        {
                            "name": "MicrosoftAppPassword",
                            "value": "[parameters('MicrosoftAppPassword')]"
                        },
                        {
                            "name": "vivaSalesLicensingCertName",
                            "value": "[parameters('vivaSalesLicensingCertName')]"
                        },
                        {
                            "name": "vivaSalesLicensing1pAppId",
                            "value": "[parameters('vivaSalesLicensing1pAppId')]"
                        },
                        {
                            "name": "scaleunit",
                            "value": "[parameters('scaleUnit')]"
                        },
                        {
                            "name": "EnvironmentType",
                            "value": "[parameters('env_type')]"
                        },
                        {
                            "name": "vivaSalesApplicationId",
                            "value": "[parameters('vivaSalesApplicationId')]"
                        },
                        {
                            "name": "defaultLocationExpiryDays",
                            "value": "[parameters('defaultLocationExpiryDays')]"
                        },
                        {
                            "name": "crmConnectionDetailsCacheExpiryMinutes",
                            "value": "[parameters('crmConnectionDetailsCacheExpiryMinutes')]"
                        },
                        {
                            "name": "PowerAppsClusterCategory",
                            "value": "[parameters('BaseExternalDependencies').PowerAppsClusterCategory]"
                        },
                        {
                            "name": "islandHostname",
                            "value": "[parameters('islandHostname')]"
                        },
                        {
                            "name": "insightsplatform_scope",
                            "value": "[parameters('BaseExternalDependencies').insightsplatform_scope]"
                        },
                        {
                            "name": "ExtensibilityFramework__PowerAppsClusterCategory",
                            "value": "[parameters('BaseExternalDependencies').PowerAppsClusterCategory]"
                        },
                        {
                            "name": "ExtensibilityFramework__ConnectorSignInRedirectUrl",
                            "value": "[parameters('BaseExternalDependencies').ConnectorSignInRedirectUrl]"
                        },
                        {
                            "name": "ExtensibilityFramework__ConnectorStaticSignInRedirectUrl",
                            "value": "[parameters('BaseExternalDependencies').ConnectorStaticSignInRedirectUrl]"
                        },
                        {
                            "name": "ExtensibilityFramework__ConnectorWidgetSignInRedirectUrl",
                            "value": "[parameters('BaseExternalDependencies').ConnectorWidgetSignInRedirectUrl]"
                        },
                        {
                            "name": "HstsMaxAgeInMinutes",
                            "value": "[parameters('hstsMaxAgeInMinutes')]"
                        },
                        {
                            "name": "UserLicenseCacheExpirationInMinutes",
                            "value": "[variables('UserLicenseCacheExpirationInMinutes')]"
                        }
                    ],
                    "metadata": [
                        {
                            "name": "CURRENT_STACK",
                            "value": "dotnet"
                        }
                    ]
                }
            },
            "resources": [
                {
                    "name": "MSDeploy",
                    "type": "Extensions",
                    "apiVersion": "2018-02-01",
                    "dependsOn": ["[resourceId('Microsoft.Web/sites/slots', variables('spWebAppName'), 'staging')]"],
                    "properties": {
                        "packageUri": "[variables('servicePackageLink')]"
                    }
                }
            ]
        },
        {
            "apiVersion": "2018-11-01",
            "type": "Microsoft.Web/sites",
            "kind": "app",
            "name": "[variables('spWebAppName')]",
            "location": "[variables('location')]",
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {
                "targetBuildVersion": "[parameters('buildVersion')]",
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('spWebAppHostingPlanName'))]",
                "httpsOnly": true,
                "netFrameworkVersion": "v8.0",
                "virtualNetworkSubnetId": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), 'default')]",
                "siteConfig": {
                    "location": "[variables('location')]",
                    "AlwaysOn": true,
                    "metadata": [
                        {
                            "name": "CURRENT_STACK",
                            "value": "dotnet"
                        }
                    ]
                }
            },
            "dependsOn": [
                "[resourceId('Microsoft.Web/sites/slots/extensions', variables('spWebAppName'), 'staging', 'MSDeploy')]",
                "[resourceId('Microsoft.Web/sites/slots', variables('spWebAppName'), 'staging')]"
            ]
        }
    ]
}
