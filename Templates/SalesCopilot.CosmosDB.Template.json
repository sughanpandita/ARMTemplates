{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "scaleUnit": {
            "type": "string",
            "metadata": {
                "description": "Describes the scale unit that is to be used to uniquely identify each resource"
            }
        },
        "hasCosmosBCDRRegion": {
            "type": "bool"
        },
        "backupStorageRedundancy": {
            "defaultValue": "Geo",
            "type": "string"
        },
        "cosmosreadwritelocation": {
            "type": "string",
            "metadata": {
                "description": "Cosmos Read/Write Location"
            }
        },
        "cosmosSecondarylocation": {
            "type": "string"
        },
        "connectionInfoCollectionThroughput": {
            "type": "int",
            "defaultValue": 400
        },
        "notificationCollectionThroughput": {
            "type": "int",
            "defaultValue": 400
        },
        "tenantSettingsCollectionThroughput": {
            "type": "int",
            "defaultValue": 400
        },
        "collabSpacesCollectionThroughput": {
            "type": "int",
            "defaultValue": 400
        },
        "publicipaddress": {
            "defaultValue": "NAT-IP-SPPublicIPAddress",
            "type": "string"
        }
    },
    "variables": {
        "location": "[resourceGroup().location]",
        "spWebAppPrefix": "salesproductivityservice",
        "spWebAppName": "[concat(variables('spWebAppPrefix'),parameters('scaleUnit'))]",
        "identityResourceId": "[concat(resourceId('Microsoft.Web/sites', variables('spWebAppName')),'/providers/Microsoft.ManagedIdentity/Identities/default')]",
        "cosmosdb": "cosmosdatabase",
        "cosmosdatabasename": "[concat(variables('cosmosdb'),parameters('scaleUnit'))]",
        "tenantInfoDB": "VivaSalesTenantInfoDb",
        "publicIPAddressName": "[concat(parameters('publicipaddress'),parameters('scaleUnit'))]",
        "documentDbContributorRoleDefinitionId": "00000000-0000-0000-0000-000000000002",
        "documentDbRoleAssignmentId": "4e9ef385-ba96-48be-8398-47ff269f8c03",
        "connectionInfoDbName": "VivaSalesConnectionInfoDb",
        "connectionInfoContainerName": "ConnectionInfo",
        "licenseBackfillDbName": "VivaSalesLicenseBackfillInfoDb",
        "tenantLicensesBackfillContainerName": "TenantsLicenses",
        "userLicensesBackfillContainerName": "UsersLicenses",
        "autoInstallDbName": "AutoInstallDb",
        "autoInstallStatusContainerName": "AutoInstallStatus",
        "installDbName": "InstallDb",
        "installStatusContainerName": "InstallStatus",
        "notificationDbName": "NotificationDb",
        "notificationContainerName": "Notification",
        "salesCopilotTenantSettingsDbName": "SalesCopilotTenantSettingsDb",
        "salesCopilotTenantSettingsContainerName": "TenantSettings",
        "collabSpacesDbName": "CollabSpacesDb",
        "collabSpacesContainerName": "CollabSpaces"
    },
    "resources": [
        {
            "type": "Microsoft.DocumentDB/databaseAccounts",
            "apiVersion": "2021-10-15",
            "name": "[variables('cosmosdatabasename')]",
            "location": "[variables('location')]",
            "tags": {
                "defaultExperience": "Core (SQL)",
                "hidden-cosmos-mmspecial": "",
                "ResourceOwnerAlias": "skapila"
            },
            "kind": "GlobalDocumentDB",
            "identity": {
                "type": "None"
            },
            "properties": {
                "publicNetworkAccess": "Enabled",
                "enableAutomaticFailover": false,
                "enableMultipleWriteLocations": false,
                "isVirtualNetworkFilterEnabled": false,
                "virtualNetworkRules": [],
                "disableKeyBasedMetadataWriteAccess": false,
                "enableFreeTier": false,
                "enableAnalyticalStorage": false,
                "analyticalStorageConfiguration": {
                    "schemaType": "WellDefined"
                },
                "databaseAccountOfferType": "Standard",
                "defaultIdentity": "FirstPartyIdentity",
                "networkAclBypass": "None",
                "disableLocalAuth": false,
                "consistencyPolicy": {
                    "defaultConsistencyLevel": "Strong",
                    "maxIntervalInSeconds": 5,
                    "maxStalenessPrefix": 100
                },
                "locations": "[union(createArray(createObject('locationName', parameters('cosmosreadwritelocation'), 'failoverPriority', 0, 'isZoneRedundant', false())), if(parameters('hasCosmosBCDRRegion'), createArray(createObject('locationName', parameters('cosmosSecondarylocation'), 'failoverPriority', 1, 'isZoneRedundant', false())), createArray()))]",
                "cors": [],
                "capabilities": [],
                "ipRules": [
                    {
                        "ipAddressOrRange": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('publicIPAddressName')),'2020-11-01').ipAddress]"
                    },
                    {
                        "ipAddressOrRange": "207.68.190.32/27"
                    },
                    {
                        "ipAddressOrRange": "157.58.216.64/26"
                    },
                    {
                        "ipAddressOrRange": "13.106.78.32/27"
                    },
                    {
                        "ipAddressOrRange": "13.106.174.32/27"
                    },
                    {
                        "ipAddressOrRange": "194.69.119.64/26"
                    },
                    {
                        "ipAddressOrRange": "13.106.4.96/27"
                    },
                    {
                        "ipAddressOrRange": "167.220.249.128/26"
                    },
                    {
                        "ipAddressOrRange": "104.42.195.92"
                    },
                    {
                        "ipAddressOrRange": "40.76.54.131"
                    },
                    {
                        "ipAddressOrRange": "52.176.6.30"
                    },
                    {
                        "ipAddressOrRange": "52.169.50.45"
                    },
                    {
                        "ipAddressOrRange": "52.187.184.26"
                    }
                ],
                "backupPolicy": {
                    "type": "Periodic",
                    "periodicModeProperties": {
                        "backupIntervalInMinutes": 240,
                        "backupRetentionIntervalInHours": 8,
                        "backupStorageRedundancy": "[parameters('backupStorageRedundancy')]"
                    }
                },
                "networkAclBypassResourceIds": []
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
            "apiVersion": "2021-10-15",
            "name": "[concat(variables('cosmosdatabasename'), '/ProvisioningRequests')]",
            "dependsOn": [ "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]" ],
            "properties": {
                "resource": {
                    "id": "ProvisioningRequests"
                }
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
            "apiVersion": "2021-10-15",
            "name": "[concat(variables('cosmosdatabasename'), '/', variables('tenantInfoDB'))]",
            "dependsOn": [ "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]" ],
            "properties": {
                "resource": {
                    "id": "[variables('tenantInfoDB')]"
                }
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
            "apiVersion": "2021-10-15",
            "name": "[concat(variables('cosmosdatabasename'), '/VivaSalesConnectionInfoDb')]",
            "dependsOn": [ "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]" ],
            "properties": {
                "resource": {
                    "id": "VivaSalesConnectionInfoDb"
                }
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
            "apiVersion": "2021-10-15",
            "name": "[concat(variables('cosmosdatabasename'), '/', variables('licenseBackfillDbName'))]",
            "dependsOn": [ "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]" ],
            "properties": {
                "resource": {
                    "id": "[variables('licenseBackfillDbName')]"
                }
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
            "apiVersion": "2021-10-15",
            "name": "[concat(variables('cosmosdatabasename'), '/', variables('notificationDbName'))]",
            "dependsOn": [ "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]" ],
            "properties": {
                "resource": {
                    "id": "[variables('notificationDbName')]"
                }
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
            "apiVersion": "2021-10-15",
            "name": "[concat(variables('cosmosdatabasename'), '/', variables('autoInstallDbName'))]",
            "dependsOn": [ "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]" ],
            "properties": {
                "resource": {
                    "id": "[variables('autoInstallDbName')]"
                }
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
            "apiVersion": "2021-10-15",
            "name": "[concat(variables('cosmosdatabasename'), '/', variables('installDbName'))]",
            "dependsOn": [ "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]" ],
            "properties": {
                "resource": {
                    "id": "[variables('installDbName')]"
                }
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
            "apiVersion": "2021-10-15",
            "name": "[concat(variables('cosmosdatabasename'), '/', variables('salesCopilotTenantSettingsDbName'))]",
            "dependsOn": [ "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]" ],
            "properties": {
                "resource": {
                    "id": "[variables('salesCopilotTenantSettingsDbName')]"
                }
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
            "apiVersion": "2021-10-15",
            "name": "[concat(variables('cosmosdatabasename'), '/', variables('collabSpacesDbName'))]",
            "dependsOn": [ "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]" ],
            "properties": {
                "resource": {
                    "id": "[variables('collabSpacesDbName')]"
                }
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleDefinitions",
            "apiVersion": "2021-10-15",
            "name": "[concat(variables('cosmosdatabasename'), '/00000000-0000-0000-0000-000000000001')]",
            "dependsOn": [ "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]" ],
            "properties": {
                "roleName": "Cosmos DB Built-in Data Reader",
                "type": "BuiltInRole",
                "assignableScopes": [
                    "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]"
                ],
                "permissions": [
                    {
                        "dataActions": [
                            "Microsoft.DocumentDB/databaseAccounts/readMetadata",
                            "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/executeQuery",
                            "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/readChangeFeed",
                            "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/items/read"
                        ],
                        "notDataActions": []
                    }
                ]
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleDefinitions",
            "apiVersion": "2021-10-15",
            "name": "[concat(variables('cosmosdatabasename'), '/', variables('documentDbContributorRoleDefinitionId'))]",
            "dependsOn": [ "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]" ],
            "properties": {
                "roleName": "Cosmos DB Built-in Data Contributor",
                "type": "BuiltInRole",
                "assignableScopes": [
                    "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]"
                ],
                "permissions": [
                    {
                        "dataActions": [
                            "Microsoft.DocumentDB/databaseAccounts/readMetadata",
                            "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/*",
                            "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/items/*"
                        ],
                        "notDataActions": []
                    }
                ]
            }
        },
        {
            "type": "Microsoft.DocumentDb/databaseAccounts/sqlRoleAssignments",
            "name": "[concat(variables('cosmosdatabasename'), '/', variables('documentDbRoleAssignmentId'))]",
            "apiVersion": "2021-06-15",
            "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlRoleDefinitions', variables('cosmosdatabasename'), variables('documentDbContributorRoleDefinitionId'))]",
                "principalId": "[reference(variables('identityResourceId'), '2015-08-31-PREVIEW').principalId]",
                "scope": "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]"
            },
            "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlRoleDefinitions', variables('cosmosdatabasename'), variables('documentDbContributorRoleDefinitionId'))]"
            ]
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
            "apiVersion": "2022-02-15-preview",
            "name": "[concat(variables('cosmosdatabasename'), '/', variables('connectionInfoDbName'),'/', variables('connectionInfoContainerName'))]",
            "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', variables('cosmosdatabasename'), variables('connectionInfoDbName'))]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]"
            ],
            "properties": {
                "resource": {
                    "id": "ConnectionInfo",
                    "indexingPolicy": {
                        "indexingMode": "consistent",
                        "automatic": true,
                        "includedPaths": [
                            {
                                "path": "/TenantId/?"
                            },
                            {
                                "path": "/Connections/[]/IsActive/?"
                            },
                            {
                                "path": "/Connections/[]/Id/?"
                            },
                            {
                                "path": "/Connections/[]/ConnectorId/?"
                            },
                            {
                                "path": "/Connections/[]/CrmUserId/?"
                            }
                        ],
                        "excludedPaths": [
                            {
                                "path": "/*"
                            },
                            {
                                "path": "/\"_etag\"/?"
                            }
                        ]
                    },
                    "partitionKey": {
                        "paths": [ "/TenantId" ],
                        "kind": "Hash"
                    },
                    "conflictResolutionPolicy": {
                        "mode": "LastWriterWins",
                        "conflictResolutionPath": "/_ts"
                    }
                },
                "options": {
                    "throughput": "[parameters('connectionInfoCollectionThroughput')]"
                }
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/throughputSettings",
            "apiVersion": "2021-10-15",
            "name": "[concat(variables('cosmosdatabasename'), '/', variables('connectionInfoDbName'), '/', variables('connectionInfoContainerName'), '/default')]",
            "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers', variables('cosmosdatabasename'), variables('connectionInfoDbName'), variables('connectionInfoContainerName'))]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', variables('cosmosdatabasename'), variables('connectionInfoDbName'))]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]"
            ],
            "properties": {
                "resource": {
                    "throughput": "[parameters('connectionInfoCollectionThroughput')]"
                }
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
            "apiVersion": "2021-10-15",
            "name": "[concat(variables('cosmosdatabasename'), '/ProvisioningRequests/requests')]",
            "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', variables('cosmosdatabasename'), 'ProvisioningRequests')]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]"
            ],
            "properties": {
                "resource": {
                    "id": "requests",
                    "indexingPolicy": {
                        "indexingMode": "consistent",
                        "automatic": true,
                        "includedPaths": [
                            {
                                "path": "/*"
                            }
                        ],
                        "excludedPaths": [
                            {
                                "path": "/\"_etag\"/?"
                            }
                        ]
                    },
                    "partitionKey": {
                        "paths": [ "/id" ],
                        "kind": "Hash"
                    },
                    "conflictResolutionPolicy": {
                        "mode": "LastWriterWins",
                        "conflictResolutionPath": "/_ts"
                    }
                }
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/throughputSettings",
            "apiVersion": "2021-10-15",
            "name": "[concat(variables('cosmosdatabasename'), '/ProvisioningRequests/requests/default')]",
            "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers', variables('cosmosdatabasename'), 'ProvisioningRequests', 'requests')]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', variables('cosmosdatabasename'), 'ProvisioningRequests')]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]"
            ],
            "properties": {
                "resource": {
                    "throughput": 400
                }
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
            "apiVersion": "2021-10-15",
            "name": "[concat(variables('cosmosdatabasename'), '/', variables('tenantInfoDB'),'/TenantInfo')]",
            "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', variables('cosmosdatabasename'), variables('tenantInfoDB'))]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]"
            ],
            "properties": {
                "resource": {
                    "id": "TenantInfo",
                    "indexingPolicy": {
                        "indexingMode": "consistent",
                        "automatic": true,
                        "includedPaths": [
                            {
                                "path": "/*"
                            }
                        ],
                        "excludedPaths": [
                            {
                                "path": "/\"_etag\"/?"
                            }
                        ]
                    },
                    "partitionKey": {
                        "paths": [ "/id" ],
                        "kind": "Hash"
                    },
                    "conflictResolutionPolicy": {
                        "mode": "LastWriterWins",
                        "conflictResolutionPath": "/_ts"
                    }
                }
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/throughputSettings",
            "apiVersion": "2021-10-15",
            "name": "[concat(variables('cosmosdatabasename'), '/', variables('tenantInfoDB'),'/TenantInfo/default')]",
            "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers', variables('cosmosdatabasename'), variables('tenantInfoDB'), 'TenantInfo')]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', variables('cosmosdatabasename'), variables('tenantInfoDB'))]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]"
            ],
            "properties": {
                "resource": {
                    "throughput": 400
                }
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
            "apiVersion": "2021-10-15",
            "name": "[concat(variables('cosmosdatabasename'), '/', variables('licenseBackfillDbName'), '/', variables('tenantLicensesBackfillContainerName'))]",
            "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', variables('cosmosdatabasename'), variables('licenseBackfillDbName'))]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]"
            ],
            "properties": {
                "resource": {
                    "id": "[variables('tenantLicensesBackfillContainerName')]",
                    "indexingPolicy": {
                        "indexingMode": "consistent",
                        "automatic": true,
                        "includedPaths": [
                            {
                                "path": "/*"
                            }
                        ],
                        "excludedPaths": [
                            {
                                "path": "/\"_etag\"/?"
                            }
                        ]
                    },
                    "partitionKey": {
                        "paths": [ "/id" ],
                        "kind": "Hash"
                    },
                    "conflictResolutionPolicy": {
                        "mode": "LastWriterWins",
                        "conflictResolutionPath": "/_ts"
                    }
                }
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/throughputSettings",
            "apiVersion": "2021-10-15",
            "name": "[concat(variables('cosmosdatabasename'), '/', variables('licenseBackfillDbName'), '/', variables('tenantLicensesBackfillContainerName'), '/default')]",
            "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers', variables('cosmosdatabasename'), variables('licenseBackfillDbName'), variables('tenantLicensesBackfillContainerName'))]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', variables('cosmosdatabasename'), variables('licenseBackfillDbName'))]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]"
            ],
            "properties": {
                "resource": {
                    "throughput": 400
                }
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
            "apiVersion": "2021-10-15",
            "name": "[concat(variables('cosmosdatabasename'), '/', variables('licenseBackfillDbName'), '/', variables('userLicensesBackfillContainerName'))]",
            "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', variables('cosmosdatabasename'), variables('licenseBackfillDbName'))]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]"
            ],
            "properties": {
                "resource": {
                    "id": "[variables('userLicensesBackfillContainerName')]",
                    "indexingPolicy": {
                        "indexingMode": "consistent",
                        "automatic": true,
                        "includedPaths": [
                            {
                                "path": "/*"
                            }
                        ],
                        "excludedPaths": [
                            {
                                "path": "/\"_etag\"/?"
                            }
                        ]
                    },
                    "partitionKey": {
                        "paths": [ "/tenantId" ],
                        "kind": "Hash"
                    },
                    "conflictResolutionPolicy": {
                        "mode": "LastWriterWins",
                        "conflictResolutionPath": "/_ts"
                    }
                }
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/throughputSettings",
            "apiVersion": "2021-10-15",
            "name": "[concat(variables('cosmosdatabasename'), '/', variables('licenseBackfillDbName'), '/', variables('userLicensesBackfillContainerName'), '/default')]",
            "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers', variables('cosmosdatabasename'), variables('licenseBackfillDbName'), variables('userLicensesBackfillContainerName'))]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', variables('cosmosdatabasename'), variables('licenseBackfillDbName'))]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]"
            ],
            "properties": {
                "resource": {
                    "throughput": 400
                }
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
            "apiVersion": "2021-10-15",
            "name": "[concat(variables('cosmosdatabasename'), '/', variables('autoInstallDbName'), '/', variables('autoInstallStatusContainerName'))]",
            "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', variables('cosmosdatabasename'), variables('autoInstallDbName'))]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]"
            ],
            "properties": {
                "resource": {
                    "id": "[variables('autoInstallStatusContainerName')]",
                    "indexingPolicy": {
                        "indexingMode": "consistent",
                        "automatic": true,
                        "includedPaths": [
                            {
                                "path": "/*"
                            }
                        ],
                        "excludedPaths": [
                            {
                                "path": "/\"_etag\"/?"
                            }
                        ]
                    },
                    "partitionKey": {
                        "paths": [ "/TenantId" ],
                        "kind": "Hash"
                    },
                    "uniqueKeyPolicy": {
                        "uniqueKeys": [
                            {
                                "paths": [ "/UserId", "/AppId" ]
                            }
                        ]
                    },
                    "conflictResolutionPolicy": {
                        "mode": "LastWriterWins",
                        "conflictResolutionPath": "/_ts"
                    }
                }
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/throughputSettings",
            "apiVersion": "2021-10-15",
            "name": "[concat(variables('cosmosdatabasename'), '/', variables('autoInstallDbName'), '/', variables('autoInstallStatusContainerName'), '/default')]",
            "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers', variables('cosmosdatabasename'), variables('autoInstallDbName'), variables('autoInstallStatusContainerName'))]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', variables('cosmosdatabasename'), variables('autoInstallDbName'))]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]"
            ],
            "properties": {
                "resource": {
                    "throughput": 400
                }
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
            "apiVersion": "2021-10-15",
            "name": "[concat(variables('cosmosdatabasename'), '/', variables('installDbName'), '/', variables('installStatusContainerName'))]",
            "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', variables('cosmosdatabasename'), variables('installDbName'))]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]"
            ],
            "properties": {
                "resource": {
                    "id": "[variables('installStatusContainerName')]",
                    "indexingPolicy": {
                        "indexingMode": "consistent",
                        "automatic": true,
                        "includedPaths": [
                            {
                                "path": "/TenantId/?"
                            },
                            {
                                "path": "/OrgId/?"
                            },
                            {
                                "path": "/InstallStatus/JobId/?"
                            }
                        ],
                        "excludedPaths": [
                            {
                                "path": "/*"
                            },
                            {
                                "path": "/\"_etag\"/?"
                            }
                        ]
                    },
                    "partitionKey": {
                        "paths": [ "/TenantId" ],
                        "kind": "Hash"
                    },
                    "conflictResolutionPolicy": {
                        "mode": "LastWriterWins",
                        "conflictResolutionPath": "/_ts"
                    }
                }
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/throughputSettings",
            "apiVersion": "2021-10-15",
            "name": "[concat(variables('cosmosdatabasename'), '/', variables('installDbName'), '/', variables('installStatusContainerName'), '/default')]",
            "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers', variables('cosmosdatabasename'), variables('installDbName'), variables('installStatusContainerName'))]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', variables('cosmosdatabasename'), variables('installDbName'))]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]"
            ],
            "properties": {
                "resource": {
                    "throughput": 400
                }
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
            "apiVersion": "2023-04-15",
            "name": "[concat(variables('cosmosdatabasename'), '/', variables('notificationDbName'),'/', variables('notificationContainerName'))]",
            "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', variables('cosmosdatabasename'), variables('notificationDbName'))]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]"
            ],
            "properties": {
                "resource": {
                    "id": "Notification",
                    "indexingPolicy": {
                        "indexingMode": "consistent",
                        "automatic": true,
                        "includedPaths": [
                            {
                                "path": "/requestId/?"
                            },
                            {
                                "path": "/userId/?"
                            },
                            {
                                "path": "/tenantId/?"
                            },
                            {
                                "path": "/externalTemplateId/?"
                            },
                            {
                                "path": "/notificationSendingPlatform/?"
                            },
                            {
                                "path": "/notificationCategory/?"
                            },
                            {
                                "path": "/state/?"
                            },
                            {
                                "path": "/expirationDate/?"
                            },
                            {
                                "path": "/scheduledTime/?"
                            },
                            {
                                "path": "/locale/?"
                            }
                        ],
                        "excludedPaths": [
                            {
                                "path": "/*"
                            },
                            {
                                "path": "/\"_etag\"/?"
                            }
                        ]
                    },
                    "partitionKey": {
                        "paths": [ "/id" ],
                        "kind": "Hash"
                    },
                    "defaultTtl": 2592000,
                    "conflictResolutionPolicy": {
                        "mode": "LastWriterWins",
                        "conflictResolutionPath": "/_ts"
                    }
                },
                "options": {
                    "throughput": "[parameters('notificationCollectionThroughput')]"
                }
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/throughputSettings",
            "apiVersion": "2023-04-15",
            "name": "[concat(variables('cosmosdatabasename'), '/', variables('notificationDbName'), '/', variables('notificationContainerName'), '/default')]",
            "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers', variables('cosmosdatabasename'), variables('notificationDbName'), variables('notificationContainerName'))]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', variables('cosmosdatabasename'), variables('notificationDbName'))]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]"
            ],
            "properties": {
                "resource": {
                    "throughput": "[parameters('notificationCollectionThroughput')]"
                }
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
            "apiVersion": "2023-04-15",
            "name": "[concat(variables('cosmosdatabasename'), '/', variables('salesCopilotTenantSettingsDbName'),'/', variables('salesCopilotTenantSettingsContainerName'))]",
            "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', variables('cosmosdatabasename'), variables('salesCopilotTenantSettingsDbName'))]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]"
            ],
            "properties": {
                "resource": {
                    "id": "[variables('salesCopilotTenantSettingsContainerName')]",
                    "indexingPolicy": {
                        "indexingMode": "consistent",
                        "automatic": true,
                        "includedPaths": [
                            {
                                "path": "/settings/?"
                            }
                        ],
                        "excludedPaths": [
                            {
                                "path": "/*"
                            },
                            {
                                "path": "/\"_etag\"/?"
                            }
                        ]
                    },
                    "partitionKey": {
                        "paths": [ "/id" ],
                        "kind": "Hash"
                    },
                    "conflictResolutionPolicy": {
                        "mode": "LastWriterWins",
                        "conflictResolutionPath": "/_ts"
                    }
                },
                "options": {
                    "throughput": "[parameters('tenantSettingsCollectionThroughput')]"
                }
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/throughputSettings",
            "apiVersion": "2023-04-15",
            "name": "[concat(variables('cosmosdatabasename'), '/', variables('salesCopilotTenantSettingsDbName'),'/', variables('salesCopilotTenantSettingsContainerName'), '/default')]",
            "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers', variables('cosmosdatabasename'), variables('salesCopilotTenantSettingsDbName'), variables('salesCopilotTenantSettingsContainerName'))]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', variables('cosmosdatabasename'), variables('salesCopilotTenantSettingsDbName'))]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]"
            ],
            "properties": {
                "resource": {
                    "throughput": "[parameters('tenantSettingsCollectionThroughput')]"
                }
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
            "apiVersion": "2023-04-15",
            "name": "[concat(variables('cosmosdatabasename'), '/', variables('collabSpacesDbName'),'/', variables('collabSpacesContainerName'))]",
            "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', variables('cosmosdatabasename'), variables('collabSpacesDbName'))]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]"
            ],
            "properties": {
                "resource": {
                    "id": "[variables('collabSpacesContainerName')]",
                    "indexingPolicy": {
                        "indexingMode": "consistent",
                        "automatic": true,
                        "includedPaths": [],
                        "excludedPaths": [
                            {
                                "path": "/*"
                            },
                            {
                                "path": "/\"_etag\"/?"
                            }
                        ]
                    },
                    "partitionKey": {
                        "paths": [ "/TenantId" ],
                        "kind": "Hash"
                    },
                    "conflictResolutionPolicy": {
                        "mode": "LastWriterWins",
                        "conflictResolutionPath": "/_ts"
                    }
                },
                "options": {
                    "throughput": "[parameters('collabSpacesCollectionThroughput')]"
                }
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/throughputSettings",
            "apiVersion": "2023-04-15",
            "name": "[concat(variables('cosmosdatabasename'), '/', variables('collabSpacesDbName'),'/', variables('collabSpacesContainerName'), '/default')]",
            "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers', variables('cosmosdatabasename'), variables('collabSpacesDbName'), variables('collabSpacesContainerName'))]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', variables('cosmosdatabasename'), variables('collabSpacesDbName'))]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosdatabasename'))]"
            ],
            "properties": {
                "resource": {
                    "throughput": "[parameters('collabSpacesCollectionThroughput')]"
                }
            }
        }
    ]
}
